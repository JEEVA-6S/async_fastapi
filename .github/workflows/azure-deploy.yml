name: Deploy to Azure Container Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  RESOURCE_GROUP: async-fastapi-rg
  ACR_NAME: asyncfastapiacr
  IMAGE_NAME: async-fastapi

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to ACR
      run: |
        az acr login --name ${{ env.ACR_NAME }}

    - name: Build and push image
      run: |
        IMAGE_TAG=$(date +%Y%m%d-%H%M%S)
        az acr build \
          --registry ${{ env.ACR_NAME }} \
          --image ${{ env.IMAGE_NAME }}:${IMAGE_TAG} \
          --image ${{ env.IMAGE_NAME }}:latest \
          --file Dockerfile \
          .
        echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

    - name: Update FastAPI Container App
      run: |
        az containerapp update \
          --name fastapi-app \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    - name: Update Celery Worker
      run: |
        az containerapp update \
          --name celery-worker \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    - name: Update Celery Beat
      run: |
        az containerapp update \
          --name celery-beat \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    - name: Update Flower
      run: |
        az containerapp update \
          --name flower \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    - name: Get application URLs
      run: |
        echo "### Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        FASTAPI_URL=$(az containerapp show \
          --name fastapi-app \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn -o tsv)
        
        FLOWER_URL=$(az containerapp show \
          --name flower \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn -o tsv)
        
        echo "- **FastAPI App**: https://${FASTAPI_URL}" >> $GITHUB_STEP_SUMMARY
        echo "- **Flower Dashboard**: https://${FLOWER_URL}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Tag**: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
